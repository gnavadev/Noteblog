---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";
import BlogShell from "../../components/BlogShell";

const { name } = Astro.params;

if (!name) {
    return Astro.redirect("/404");
}

const [postsResult, topicsResult] = await Promise.all([
    supabase
        .from("notes")
        .select("*")
        .eq("is_public", true)
        .order("created_at", { ascending: false }),
    supabase.from("topics").select("*").order("order", { ascending: true }),
]);

const posts = postsResult.data || [];
const topics = topicsResult.data || [];
const topicName = decodeURIComponent(name);

// Basic check to see if topic is valid
const topicExists =
    topics.some((t) => t.name === topicName) ||
    posts.some((p) => p.topic === topicName);

if (!topicExists) {
    return Astro.redirect("/404");
}
---

<Layout title={`Stories in ${topicName}`}>
    <BlogShell
        client:load
        initialPosts={posts}
        initialTopics={topics}
        initialTopic={topicName}
    />
</Layout>
