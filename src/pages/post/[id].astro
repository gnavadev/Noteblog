---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";
import ReactiveMarkdownViewer from "../../components/blog/ReactiveMarkdownViewer";
import Comments from "../../components/comments/Comments";
import { ThemeToggle } from "../../components/blog/ThemeToggle";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Clock, Calendar } from "lucide-react";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/404");
}

// Fetch only what we need for this specific post
const [postResult, topicsResult] = await Promise.all([
    supabase.from("notes").select("*").eq("id", id).single(),
    supabase.from("topics").select("id, name, color"),
]);

const { data: post, error } = postResult;

if (error || !post) {
    return Astro.redirect("/404");
}

// Get topic color
let topicColor = "#007aff";
const topics = topicsResult.data || [];
const matchingTopic = topics.find(
    (t) =>
        (post.topic_id && t.id === post.topic_id) ||
        (!post.topic_id && t.name === post.topic),
);
topicColor = matchingTopic?.color || topicColor;

const formattedDate = new Date(post.created_at).toLocaleDateString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
    timeZone: "UTC",
});
---

<Layout
    title={post.title}
    description={post.content.slice(0, 160)}
    image={post.featured_image}
>
    <!-- Focus Mode Layout -->
    <div
        class="min-h-screen bg-background text-foreground flex flex-col items-center py-12 px-6 transition-colors duration-300"
    >
        <!-- Floating Navigation -->
        <div
            class="fixed top-8 right-4 left-auto sm:right-auto sm:left-8 z-50 flex items-center gap-4"
        >
            <a href="/">
                <Button
                    variant="outline"
                    className="rounded-full gap-2 pl-3 pr-5 shadow-lg bg-background/80 backdrop-blur-xl border-primary/20 hover:border-primary/50 transition-all hover:scale-105 active:scale-95 group"
                >
                    <ArrowLeft
                        className="w-5 h-5 text-primary group-hover:-translate-x-1 transition-transform"
                    />
                    <span class="font-bold tracking-tight">Back to Blog</span>
                </Button>
            </a>
        </div>

        <div class="fixed bottom-8 right-8 z-50">
            <ThemeToggle client:load />
        </div>

        <article
            class="w-full max-w-5xl space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-700"
        >
            <!-- Header Section -->
            <header class="space-y-8">
                <div class="flex items-center gap-3">
                    <span
                        class="px-4 py-1.5 rounded-full text-[0.7rem] font-black uppercase tracking-[0.2em] text-white shadow-xl shadow-primary/20"
                        style={`background-color: ${topicColor}`}
                    >
                        {post.topic}
                    </span>
                </div>

                <h1
                    class="text-5xl md:text-7xl font-black tracking-tight leading-[1.1] text-balance"
                >
                    {post.title}
                </h1>

                <div
                    class="flex flex-wrap items-center gap-8 text-sm font-bold text-muted-foreground/60 tracking-wide uppercase"
                >
                    <div class="flex items-center gap-2.5">
                        <Calendar className="h-4 w-4 text-primary" />
                        <span>{formattedDate}</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <Clock className="h-4 w-4 text-primary" />
                        <span>{post.read_time_minutes} min read</span>
                    </div>
                </div>
            </header>

            <div
                class="h-px w-full bg-gradient-to-r from-primary/30 via-border to-transparent"
            >
            </div>

            <!-- Content Section -->
            <div class="w-full max-w-none">
                <ReactiveMarkdownViewer
                    content={post.content}
                    client:only="react"
                />
            </div>

            <div class="pt-20 space-y-12">
                <div
                    class="h-px w-full bg-gradient-to-r from-transparent via-border to-transparent"
                >
                </div>

                <section class="max-w-[700px] mx-auto">
                    <h2 class="text-3xl font-black tracking-tight mb-8">
                        Conversations
                    </h2>
                    <!-- Ensure client:load is present for interactivity -->
                    <Comments postId={post.id} isAdmin={false} client:load />
                </section>

                <footer
                    class="pt-20 pb-12 text-center border-t border-border/40"
                >
                    <p
                        class="text-sm font-black text-muted-foreground/30 uppercase tracking-[0.3em]"
                    >
                        © {new Date().getFullYear()} Gabriel Nava — Crafted with Passion
                    </p>
                </footer>
            </div>
        </article>
    </div>
</Layout>

<style is:global>
    /* Premium Typography and Spacing */
    @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap");

    body {
        font-family: "Outfit", sans-serif;
    }

    .prose h2,
    .prose h3 {
        margin-top: 2.5em;
        margin-bottom: 1em;
    }

    .prose p {
        margin-bottom: 1.8em;
    }
</style>
