---
import Layout from "../layouts/Layout.astro";
import BlogShell from "../components/BlogShell";
import { supabase } from "../lib/supabase";

const [postsResult, topicsResult, recentContentResult] = await Promise.all([
	supabase
		.from("notes")
		.select(
			"id, created_at, title, topic, user_id, color, is_public, layout_json, category_color, read_time_minutes, featured_image, topic_id",
		)
		.eq("is_public", true)
		.order("created_at", { ascending: false }),
	supabase.from("topics").select("*").order("order", { ascending: true }),
	supabase
		.from("notes")
		.select("id, content")
		.eq("is_public", true)
		.order("created_at", { ascending: false })
		.limit(6),
]);

let posts = postsResult.data || [];
const topics = topicsResult.data || [];
const recentContent = recentContentResult.data || [];

// Merge the heavy preview content into the first 6 light metadata arrays
if (recentContent.length > 0) {
	posts = posts.map((post) => {
		const match = recentContent.find((rc) => rc.id === post.id);
		return match ? { ...post, content: match.content } : post;
	});
}
---

<Layout title="Segmentation Thoughts">
	<BlogShell client:load initialPosts={posts} initialTopics={topics} />
</Layout>

<style is:global>
	/* Background needs to be explicitly set for the whole page */
	body {
		background-color: var(--app-bg) !important;
		overflow: hidden;
	}
</style>
