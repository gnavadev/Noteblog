---
export const prerender = false;
Astro.response.headers.set(
	"Cache-Control",
	"s-maxage=60, stale-while-revalidate=3600",
);

import Layout from "../layouts/Layout.astro";
import BlogShell from "../components/BlogShell";
import { supabase } from "../lib/supabase";

const [postsResult, topicsResult, recentContentResult] = await Promise.all([
	supabase
		.from("notes")
		.select(
			"id, created_at, title, topic, user_id, color, is_public, layout_json, category_color, read_time_minutes, featured_image, topic_id",
		)
		.eq("is_public", true)
		.order("created_at", { ascending: false }),
	supabase.from("topics").select("*").order("order", { ascending: true }),
	supabase
		.from("notes")
		.select("id, content")
		.eq("is_public", true)
		.order("created_at", { ascending: false })
		.limit(6),
]);

let posts = postsResult.data || [];
const topics = topicsResult.data || [];
const recentContent = recentContentResult.data || [];

// Merge a lightweight text excerpt into the first 6 posts (discarding the heavy content body!)
if (recentContent.length > 0) {
	posts = posts.map((post) => {
		const match = recentContent.find((rc) => rc.id === post.id);
		if (match && match.content) {
			// Strip massive base64 image data and truncate text!
			let rawText = match.content.replace(
				/data:image\/[^;]+;base64,[^\)"]+/g,
				"",
			);
			let excerpt = rawText.substring(0, 400);
			return { ...post, excerpt };
		}
		return post;
	});
}
---

<Layout title="Segmentation Thoughts">
	<BlogShell client:load initialPosts={posts} initialTopics={topics} />
</Layout>

<style is:global>
	/* Background needs to be explicitly set for the whole page */
	body {
		background-color: var(--app-bg) !important;
		overflow: hidden;
	}
</style>
