---
// Draw.io Integration Page
// Bridges Cherry Markdown Editor with diagrams.net embed
---

<!doctype html>
<html lang="en" style="height: 100%; width: 100%; overflow: hidden;">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Draw.io Integration</title>
    </head>
    <body
        style="height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"
    >
        <!-- 
      Embed Draw.io in iframe. 
      params:
      - embed=1: Embed mode
      - ui=min: Minimal UI
      - spin=1: Show spinner on save
      - proto=json: JSON protocol for messages
      - configure=1: REMOVED to avoid waiting for config
      - libraries=1: Enable libraries
      - noSaveBtn=1: Hide save button
    -->
        <iframe
            id="drawio-iframe"
            src="https://embed.diagrams.net/?embed=1&ui=min&spin=1&proto=json&libraries=1&noSaveBtn=1"
            style="width: 100%; height: 100%; border: 0;"
            allow="clipboard-write"></iframe>

        <script is:inline>
            (function () {
                var iframe = document.getElementById("drawio-iframe");
                var pendingExport = false;
                var accumulatedData = { xmlData: "", base64: "" };

                window.addEventListener("message", function (e) {
                    if (!e.data) return;

                    // 1. Identify Source
                    var isFromIframe = e.source === iframe.contentWindow;
                    var isFromParent =
                        e.source === window.parent ||
                        (!isFromIframe && e.data.eventName);

                    // --- Handle Message from PARENT (Cherry) ---
                    if (isFromParent && e.data.eventName) {
                        console.log(
                            "[DrawIO Bridge] From Parent:",
                            e.data.eventName,
                            e.data,
                        );

                        if (e.data.eventName === "setData") {
                            window.initialXml = e.data.value;
                        }

                        if (e.data.eventName === "getData") {
                            pendingExport = true;
                            accumulatedData = { xmlData: "", base64: "" };
                            console.log(
                                "[DrawIO Bridge] Requesting XML Export...",
                            );
                            var msg = JSON.stringify({
                                action: "export",
                                format: "xml",
                            });
                            iframe.contentWindow.postMessage(msg, "*");
                        }

                        if (e.data.eventName === "ready?") {
                            console.log(
                                "[DrawIO Bridge] Sending ready to Parent",
                            );
                            window.parent.postMessage(
                                { eventName: "ready", value: "" },
                                "*",
                            );
                        }
                        return;
                    }

                    // --- Handle Message from IFRAME (Draw.io) ---
                    var msg = e.data;
                    if (typeof msg === "string") {
                        try {
                            msg = JSON.parse(msg);
                        } catch (err) {
                            return;
                        }
                    }

                    if (msg && msg.event) {
                        // Filter noisy events
                        if (
                            msg.event === "configure" ||
                            msg.event === "autosave" ||
                            msg.event === "status"
                        )
                            return;

                        console.log("[DrawIO Bridge] From Iframe:", msg.event);

                        if (msg.event === "init") {
                            var xml = window.initialXml || "";
                            console.log(
                                "[DrawIO Bridge] Sending LOAD to Iframe (XML len: " +
                                    xml.length +
                                    ")",
                            );

                            iframe.contentWindow.postMessage(
                                JSON.stringify({
                                    action: "load",
                                    autosave: 0,
                                    xml: xml,
                                }),
                                "*",
                            );

                            // Also tell Cherry we are ready
                            window.parent.postMessage(
                                { eventName: "ready", value: "" },
                                "*",
                            );
                        }

                        if (msg.event === "export") {
                            if (!pendingExport) return;

                            if (!accumulatedData.xmlData) {
                                console.log(
                                    "[DrawIO Bridge] XML received. Requesting PNG...",
                                );
                                accumulatedData.xmlData = msg.data;

                                iframe.contentWindow.postMessage(
                                    JSON.stringify({
                                        action: "export",
                                        format: "png",
                                        spin: "Updating preview...",
                                    }),
                                    "*",
                                );
                            } else {
                                console.log(
                                    "[DrawIO Bridge] PNG received. Done.",
                                );
                                accumulatedData.base64 = msg.data; // data:image/png;base64,...

                                window.parent.postMessage(
                                    {
                                        eventName: "getData:success",
                                        mceAction: "getData:success",
                                        value: accumulatedData,
                                    },
                                    "*",
                                );

                                pendingExport = false;
                            }
                        }
                    }
                });
            })();
        </script>
    </body>
</html>
