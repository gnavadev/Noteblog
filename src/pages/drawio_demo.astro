---
// Draw.io Integration Page
// Bridges Cherry Markdown Editor with diagrams.net embed
---

<!doctype html>
<html lang="en" style="height: 100%; width: 100%; overflow: hidden;">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Draw.io Integration</title>
    </head>
    <body
        style="height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;"
    >
        <!--
      Embed Draw.io in iframe.
      params:
      - embed=1: Embed mode
      - ui=min: Minimal UI (atlas)
      - spin=1: Show spinner on save
      - proto=json: JSON protocol
      - libraries=1: Enable libraries
      - noSaveBtn=1: Hide save button
      - lang=en: Force English
    -->
        <iframe
            id="drawio-iframe"
            src="https://embed.diagrams.net/?embed=1&ui=atlas&spin=1&proto=json&libraries=1&noSaveBtn=1&lang=en&dark=1&configure=1"
            style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; border: 0; display: block;"
            allow="clipboard-write"></iframe>

        <script is:inline>
            (function () {
                var iframe = document.getElementById("drawio-iframe");
                var pendingExport = false;
                var accumulatedData = { xmlData: "", base64: "" };

                window.addEventListener("message", function (e) {
                    if (!e.data) return;

                    // Security: Verify Origin
                    // We allow messages from:
                    // 1. The iframe (diagrams.net) where we trust the logic
                    // 2. The parent window (our own app)
                    // Note: In production, you might want to strictly check e.origin specific domains

                    var isFromIframe = e.source === iframe.contentWindow;
                    var isFromParent =
                        e.source === window.parent ||
                        (!isFromIframe && e.data.eventName);

                    if (!isFromIframe && !isFromParent) {
                        // Untrusted source
                        return;
                    }

                    // --- Handle Message from PARENT (Cherry) ---
                    if (isFromParent && e.data.eventName) {
                        if (e.data.eventName === "setData") {
                            window.initialXml = e.data.value;
                        }

                        if (e.data.eventName === "getData") {
                            pendingExport = true;
                            accumulatedData = { xmlData: "", base64: "" };
                            var msg = JSON.stringify({
                                action: "export",
                                format: "xml",
                            });
                            iframe.contentWindow.postMessage(msg, "*");
                        }

                        if (e.data.eventName === "ready?") {
                            window.parent.postMessage(
                                { eventName: "ready", value: "" },
                                "*", // Parent origin is dynamically determined, usually same-origin or trusted
                            );
                        }
                        return;
                    }

                    // --- Handle Message from IFRAME (Draw.io) ---
                    var msg = e.data;
                    if (typeof msg === "string") {
                        try {
                            msg = JSON.parse(msg);
                        } catch (err) {
                            return;
                        }
                    }

                    if (msg && msg.event) {
                        // Handle configure event
                        if (msg.event === "configure") {
                            iframe.contentWindow.postMessage(
                                JSON.stringify({
                                    action: "configure",
                                    config: {
                                        language: "",
                                        configVersion: null,
                                        customFonts: [],
                                        libraries:
                                            "general;uml;er;bpmn;flowchart;basic;arrows2",
                                        customLibraries: [],
                                        plugins: [],
                                        recentColors: [],
                                        formatWidth: "240",
                                        createTarget: false,
                                        pageFormat: {
                                            x: 0,
                                            y: 0,
                                            width: 850,
                                            height: 1100,
                                        },
                                        search: true,
                                        showStartScreen: false,
                                        gridColor: "#d0d0d0",
                                        darkGridColor: "#424242",
                                        darkMode: true,
                                        autosave: true,
                                        resizeImages: null,
                                        openCounter: 5,
                                        version: 18,
                                        unit: 1,
                                        isRulerOn: false,
                                        ui: "atlas",
                                    },
                                }),
                                "*",
                            );
                            return;
                        }

                        // Filter noisy events
                        if (msg.event === "autosave" || msg.event === "status")
                            return;

                        if (msg.event === "init") {
                            var xml = window.initialXml || "";
                            iframe.contentWindow.postMessage(
                                JSON.stringify({
                                    action: "load",
                                    autosave: 0,
                                    xml: xml,
                                }),
                                "*",
                            );

                            // Also tell Cherry we are ready
                            window.parent.postMessage(
                                { eventName: "ready", value: "" },
                                "*",
                            );
                        }

                        if (msg.event === "export") {
                            if (!pendingExport) return;

                            if (!accumulatedData.xmlData) {
                                accumulatedData.xmlData = msg.data;
                                iframe.contentWindow.postMessage(
                                    JSON.stringify({
                                        action: "export",
                                        format: "png",
                                        spin: "Updating preview...",
                                    }),
                                    "*",
                                );
                            } else {
                                accumulatedData.base64 = msg.data; // data:image/png;base64,...

                                window.parent.postMessage(
                                    {
                                        eventName: "getData:success",
                                        mceAction: "getData:success",
                                        value: accumulatedData,
                                    },
                                    "*",
                                );

                                pendingExport = false;
                            }
                        }
                    }
                });
            })();
        </script>
    </body>
</html>
